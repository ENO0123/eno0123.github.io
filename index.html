'use client'

import { useState, useEffect } from 'react'
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { generateJapaneseYears, generateMonths, generateDays } from '../utils/japaneseEra'

declare global {
  interface Window {
    liff: any;
  }
}

export default function UserInfoForm() {
  const [name, setName] = useState('')
  const [year, setYear] = useState('')
  const [month, setMonth] = useState('')
  const [day, setDay] = useState('')
  const [isLiffInitialized, setIsLiffInitialized] = useState(false)

  useEffect(() => {
    import('@line/liff').then((liff) => {
      liff.init({ liffId: '2006599482-pMxXwEm7' }).then(() => {
        setIsLiffInitialized(true)
      }).catch((error: Error) => {
        console.error('LIFF initialization failed', error)
      })
    })
  }, [])

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!isLiffInitialized) {
      console.error('LIFF is not initialized')
      return
    }

    const message = `利用者名: ${name}\n生年月日: ${year}年${month}月${day}日`
    try {
      await window.liff.sendMessages([{ type: 'text', text: message }])
      alert('情報が送信されました')
    } catch (error) {
      console.error('Failed to send message', error)
      alert('メッセージの送信に失敗しました')
    }
  }

  const years = generateJapaneseYears()
  const months = generateMonths()
  const days = generateDays()

  return (
    <div className="container mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4">利用者情報入力</h1>
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <Label htmlFor="name">利用者名</Label>
          <Input id="name" value={name} onChange={(e) => setName(e.target.value)} required />
        </div>
        <div>
          <Label>生年月日</Label>
          <div className="grid grid-cols-3 gap-2">
            <Select value={year} onValueChange={setYear} required>
              <SelectTrigger>
                <SelectValue placeholder="年" />
              </SelectTrigger>
              <SelectContent>
                {years.map((y) => (
                  <SelectItem key={y.value} value={y.value}>
                    {y.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <Select value={month} onValueChange={setMonth} required>
              <SelectTrigger>
                <SelectValue placeholder="月" />
              </SelectTrigger>
              <SelectContent>
                {months.map((m) => (
                  <SelectItem key={m.value} value={m.value}>
                    {m.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            <Select value={day} onValueChange={setDay} required>
              <SelectTrigger>
                <SelectValue placeholder="日" />
              </SelectTrigger>
              <SelectContent>
                {days.map((d) => (
                  <SelectItem key={d.value} value={d.value}>
                    {d.label}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>
        <Button type="submit" disabled={!isLiffInitialized}>送信</Button>
      </form>
    </div>
  )
}

